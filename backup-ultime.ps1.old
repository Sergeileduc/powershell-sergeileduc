<#
  Script de sauvegarde de l‚Äôenvironnement de d√©veloppement
  Destination : OneDrive\Documents\AAA-important\geek\backup\
  Sauvegarde :
    - Chocolatey
    - pip
    - Variables d‚Äôenvironnement
    - VSCode (extensions + settings)
    - Git (.gitconfig + cl√©s SSH)
    - Fly.io (config + auth)
    - Dossier .config (avec exclusions)
    - Fichiers .env (renomm√©s par projet)
    - Version horodat√©e + version "latest"
#>

function Copy-FolderWithExclusions {
  <#
    Copie un dossier source vers une destination en excluant certains fichiers ou dossiers.

    Cette fonction parcourt r√©cursivement le dossier source et copie tous les fichiers et sous-dossiers
    vers la destination, sauf ceux dont le nom ou le chemin contient un des termes d‚Äôexclusion sp√©cifi√©s.

    Param√®tres :
      - Source : chemin complet du dossier source √† copier.
      - Destination : chemin complet du dossier de destination.
      - ExcludeNames : tableau de cha√Ænes repr√©sentant les noms de fichiers ou de dossiers √† exclure.
                      La comparaison est faite sur le nom exact, le chemin complet, et les sous-dossiers.

    Notes :
      - Les exclusions sont insensibles √† la casse.
      - Les dossiers exclus ne seront pas cr√©√©s dans la destination.
      - Les fichiers dans les dossiers exclus ne seront pas copi√©s.
  #>

  param (
    [string]$Source,
    [string]$Destination,
    [string[]]$ExcludeNames
  )

  if (!(Test-Path $Destination)) {
    New-Item -ItemType Directory -Path $Destination -Force | Out-Null
  }

  Get-ChildItem -Path $Source -Recurse | Where-Object {
    foreach ($excl in $ExcludeNames) {
      if (
        $_.Name -ieq $excl -or
        $_.FullName -like "*\$excl" -or
        $_.FullName -like "*\$excl\*" -or
        $_.FullName -like "*\$excl.*"
      ) {
        return $false
      }
    }
    return $true
  } | ForEach-Object {
    $target = $_.FullName.Replace($Source, $Destination)
    if ($_.PSIsContainer) {
      if (!(Test-Path $target)) {
        New-Item -ItemType Directory -Path $target -Force | Out-Null
      }
    } else {
      Copy-Item $_.FullName -Destination $target -Force
    }
  }
}

# Racine du dossier de backup
$root = Join-Path "$env:USERPROFILE\OneDrive\Documents" "AAA-important\geek\backup"

# Timestamp du jour
$timestamp = Get-Date -Format "yyyy-MM-dd"

# Dossiers de destination
$backupTimestamped = Join-Path $root "backup-$timestamp"
$backupLatest = Join-Path $root "backup-latest"

# Cr√©e les deux dossiers
foreach ($path in @($backupTimestamped, $backupLatest)) {
  if (!(Test-Path $path)) {
    New-Item -ItemType Directory -Path $path -Force | Out-Null
    Write-Host "üìÅ Dossier cr√©√© : $path" -ForegroundColor Green
  }
}

# Fonction pour √©crire dans les deux dossiers
function Save-ToBoth($content, $filename) {
  $file1 = Join-Path $backupTimestamped $filename
  $file2 = Join-Path $backupLatest $filename
  $content | Tee-Object -FilePath $file1 -Encoding UTF8 | Out-File -FilePath $file2 -Encoding UTF8
}

# 1. Chocolatey
$chocoFile1 = Join-Path $backupTimestamped "packages-choco.config"
$chocoFile2 = Join-Path $backupLatest "packages-choco.config"
choco export --include-version-numbers $chocoFile1
Copy-Item $chocoFile1 -Destination $chocoFile2 -Force
Write-Host "‚úÖ Chocolatey export√© vers : $chocoFile1" -ForegroundColor Green

# 2. pip
Save-ToBoth (pip freeze) "requirements.txt"
Write-Host "‚úÖ pip freeze enregistr√©" -ForegroundColor Green

# 3. Variables d‚Äôenvironnement
$envVars = Get-ChildItem Env:
Save-ToBoth $envVars "env-vars.csv"
Write-Host "‚úÖ Variables d‚Äôenvironnement sauvegard√©es" -ForegroundColor Green

# 4. Extensions VSCode
Save-ToBoth (code --list-extensions) "vscode-extensions.txt"
Write-Host "‚úÖ Extensions VSCode list√©es" -ForegroundColor Green

# 5. R√©glages VSCode
$vscodeSettingsSrc = Join-Path "$env:APPDATA\Code\User" "settings.json"
foreach ($dest in @($backupTimestamped, $backupLatest)) {
  Copy-Item $vscodeSettingsSrc -Destination (Join-Path $dest "vscode-settings.json") -Force
}
Write-Host "‚úÖ R√©glages VSCode copi√©s" -ForegroundColor Green

# 6. Profil Git
$gitConfigSrc = Join-Path "$env:USERPROFILE" ".gitconfig"
foreach ($dest in @($backupTimestamped, $backupLatest)) {
  Copy-Item $gitConfigSrc -Destination (Join-Path $dest "gitconfig") -Force
}
Write-Host "‚úÖ Fichier .gitconfig sauvegard√©" -ForegroundColor Green

# 7. Cl√©s SSH
$sshSrc = Join-Path "$env:USERPROFILE" ".ssh"
$sshExclusions = @("known_hosts.old", "config.bak")

foreach ($dest in @($backupTimestamped, $backupLatest)) {
  $sshDest = Join-Path $dest "ssh"
  Copy-FolderWithExclusions -Source $sshSrc -Destination $sshDest -ExcludeNames $sshExclusions
}
Write-Host "‚úÖ Cl√©s SSH sauvegard√©es (fichiers inutiles exclus)" -ForegroundColor Green

# 8. Fly.io
$flySrc = Join-Path "$env:USERPROFILE" ".fly"
$flyExclusions = @("bin", "flyctl.exe", "flyctl", "wintun.dll")

foreach ($dest in @($backupTimestamped, $backupLatest)) {
  $flyDest = Join-Path $dest "fly"
  Copy-FolderWithExclusions -Source $flySrc -Destination $flyDest -ExcludeNames $flyExclusions
}
Write-Host "‚úÖ Config Fly.io sauvegard√©e (sans le dossier bin ni les ex√©cutables)" -ForegroundColor Green

# 9. Dossier .config (avec exclusions)
$configSrc = Join-Path "$env:USERPROFILE" ".config"
$configExclusions = @("__pycache__", "cache", "temp")

foreach ($dest in @($backupTimestamped, $backupLatest)) {
  $configDest = Join-Path $dest "config"
  Copy-FolderWithExclusions -Source $configSrc -Destination $configDest -ExcludeNames $configExclusions
}
Write-Host "‚úÖ Dossier .config sauvegard√© (exclusions appliqu√©es)" -ForegroundColor Green

# 10. Fichiers .env (renomm√©s par projet)
foreach ($dest in @($backupTimestamped, $backupLatest)) {
  $envBackupDir = Join-Path $dest "env-files"
  if (!(Test-Path $envBackupDir)) {
    New-Item -ItemType Directory -Path $envBackupDir -Force | Out-Null
  }

  $envFiles = Get-ChildItem -Path "$env:USERPROFILE" -Filter ".env" -Recurse -ErrorAction SilentlyContinue
  foreach ($file in $envFiles) {
    $projectName = Split-Path $file.DirectoryName -Leaf
    $targetName = "$projectName.env"
    $targetPath = Join-Path $envBackupDir $targetName
    Copy-Item $file.FullName -Destination $targetPath -Force
    Write-Host "‚úÖ .env sauvegard√© : $targetName" -ForegroundColor Green
  }
}

# üéâ Fin
Write-Host "`nüéâ Sauvegarde compl√®te termin√©e dans : $backupTimestamped" -ForegroundColor Cyan
Write-Host "üìå Dernier backup accessible via : $backupLatest" -ForegroundColor Cyan
